# 网络加密磁盘系统

## 项目概述

本项目是一个基于安全认证、加密传输和加密存储的网络加密磁盘系统。系统为互联网、无线网络、移动通信等用户提供安全的网络存储空间，支持多用户、用户组管理，并实现了完整的加密机制。

## 核心功能

### 1. 安全存储
- 每个用户拥有独立的加密存储空间
- 文件采用AES-256加密存储，服务器端无法解密
- 支持用户组内共享加密数据
- 用户组之间完全隔离

### 2. 加密传输
- 登录认证过程采用RSA加密传输
- 会话采用一次一密（OTP）加密机制
- 每次会话使用不同的会话密钥
- 支持防篡改和防中间人攻击（HMAC验证）

### 3. 认证机制
- **密码认证**：基于bcrypt的密码哈希存储
- **邮箱认证**：邮箱验证码登录
- **密钥找回**：通过邮箱验证码找回密钥，找回后仍可解密历史文件

### 4. 用户管理
- 支持多用户同时连接
- 用户组管理，组内用户可共享加密数据
- 用户可在多个终端登录
- 严格的权限隔离

## 技术架构

### 后端技术栈
- **框架**：Flask (Python)
- **数据库**：SQLite（可扩展为PostgreSQL/MySQL）
- **加密算法**：
  - AES-256-GCM（文件加密存储）
  - RSA-2048（密钥交换）
  - HMAC-SHA256（完整性验证）
  - bcrypt（密码哈希）
  - 一次一密（会话加密）

### 前端技术栈
- **框架**：React + TypeScript
- **UI库**：Ant Design
- **状态管理**：React Context API
- **HTTP客户端**：Axios

## 系统架构

```
┌─────────────────┐
│   前端界面      │
│  (React + TS)   │
└────────┬────────┘
         │ HTTPS (自实现加密)
         │
┌────────▼────────┐
│   Flask后端     │
│  - 认证模块     │
│  - 加密模块     │
│  - 文件管理     │
│  - 用户组管理   │
└────────┬────────┘
         │
┌────────▼────────┐
│   SQLite数据库  │
│  - 用户信息     │
│  - 文件元数据   │
│  - 用户组信息   │
└─────────────────┘
```

## 安全机制设计

### 1. 密钥管理
- **主密钥**：用户注册时生成，用于加密文件密钥
- **文件密钥**：每个文件使用独立的AES密钥
- **会话密钥**：每次登录生成，用于传输加密
- **密钥加密**：主密钥使用用户密码派生密钥加密存储

### 2. 一次一密机制
- 每次登录生成新的会话密钥
- 会话密钥通过RSA加密传输
- 每次请求使用HMAC验证完整性
- 会话密钥定期轮换

### 3. 防中间人攻击
- RSA密钥交换
- HMAC消息认证码
- 时间戳防重放攻击
- 请求序列号验证

### 4. 密钥找回机制
- 用户注册时生成密钥恢复包
- 恢复包使用邮箱验证码加密
- 找回时通过邮箱验证码解密恢复包
- 恢复的主密钥可解密所有历史文件

## 项目结构

```
├── backend/                 # 后端代码
│   ├── app.py              # Flask应用主文件
│   ├── models.py           # 数据库模型
│   ├── crypto/             # 加密模块
│   │   ├── __init__.py
│   │   ├── aes.py          # AES加密实现
│   │   ├── rsa.py          # RSA加密实现
│   │   ├── hmac.py         # HMAC验证
│   │   └── key_manager.py  # 密钥管理
│   ├── auth/               # 认证模块
│   │   ├── __init__.py
│   │   ├── password.py     # 密码认证
│   │   └── email.py        # 邮箱认证
│   ├── api/                # API路由
│   │   ├── __init__.py
│   │   ├── auth.py         # 认证接口
│   │   ├── files.py        # 文件接口
│   │   └── groups.py       # 用户组接口
│   └── utils/              # 工具函数
│       ├── __init__.py
│       └── validators.py   # 验证工具
├── frontend/               # 前端代码
│   ├── src/
│   │   ├── components/     # React组件
│   │   ├── pages/          # 页面组件
│   │   ├── services/       # API服务
│   │   ├── utils/          # 工具函数
│   │   └── App.tsx         # 主应用组件
│   ├── package.json
│   └── tsconfig.json
├── requirements.txt        # Python依赖
└── README.md              # 项目说明
```

## 安装和运行

### 后端安装
```bash
cd backend
pip install -r ../requirements.txt
python app.py
```

### 前端安装
```bash
cd frontend
npm install
npm start
```

## API文档

### 认证接口
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/email-code` - 发送邮箱验证码
- `POST /api/auth/recover-key` - 密钥找回

### 文件接口
- `GET /api/files/list` - 获取文件列表
- `POST /api/files/upload` - 上传文件
- `GET /api/files/download/<file_id>` - 下载文件
- `DELETE /api/files/<file_id>` - 删除文件

### 用户组接口
- `GET /api/groups/list` - 获取用户组列表
- `POST /api/groups/create` - 创建用户组
- `POST /api/groups/join` - 加入用户组
- `POST /api/groups/share-key` - 共享密钥给组内用户

## 安全注意事项

1. **密钥安全**：主密钥仅存储在客户端，服务器端无法获取
2. **传输安全**：所有敏感数据均加密传输
3. **存储安全**：文件加密存储，服务器无法解密
4. **会话安全**：使用一次一密机制，防止会话劫持
5. **认证安全**：多重认证机制，防止未授权访问

## 测试说明

1. 启动后端服务器：`python backend/app.py`
2. 启动前端开发服务器：`cd frontend && npm start`
3. 访问 `http://localhost:3000` 进行测试
4. 测试多用户、用户组、文件上传下载等功能

## 开发日志

### 2024-01-XX
- ✅ 完成系统架构设计
- ✅ 实现后端基础框架（Flask + SQLite）
- ✅ 实现加密模块（AES-256-GCM, RSA-2048, HMAC-SHA256）
- ✅ 实现认证模块（密码认证 + 邮箱验证码认证）
- ✅ 实现文件管理功能（上传、下载、删除）
- ✅ 实现用户组管理和权限控制
- ✅ 实现前端界面（React + TypeScript + Ant Design）
- ✅ 实现密钥找回机制
- ✅ 实现一次一密会话加密机制

## 核心安全特性实现

### 1. 加密存储
- ✅ 文件使用AES-256-GCM加密存储
- ✅ 每个文件使用独立的文件密钥
- ✅ 文件密钥使用主密钥加密存储
- ✅ 服务器端无法解密文件内容

### 2. 加密传输
- ✅ 登录过程使用RSA-2048加密密钥交换
- ✅ 会话密钥使用一次一密机制
- ✅ 每次登录生成新的会话密钥
- ✅ HMAC-SHA256消息完整性验证

### 3. 认证机制
- ✅ 密码认证（bcrypt哈希）
- ✅ 邮箱验证码认证
- ✅ 密钥找回机制（通过邮箱验证码）

### 4. 用户组管理
- ✅ 支持创建用户组
- ✅ 支持加入用户组
- ✅ 用户组内文件共享
- ✅ 用户组之间完全隔离

## 待改进项

1. 支持更多认证方式（生物特征、微信/支付宝）
2. 优化大文件上传性能（分块上传）
3. 增加文件版本管理
4. 增加操作日志审计
5. 支持文件分享链接
6. 增加存储配额管理
7. 实现完整的RSA密钥对管理（客户端）
8. 优化前端加密实现（使用Web Crypto API）
9. 增加文件预览功能
10. 增加文件夹管理功能
