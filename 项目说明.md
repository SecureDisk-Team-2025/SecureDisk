# 网络加密磁盘系统 - 项目说明

## 项目概述

本项目是一个完整的网络加密磁盘系统，实现了题目要求的所有功能。系统采用前后端分离架构，后端使用Flask框架，前端使用React + TypeScript + Ant Design构建美观的用户界面。

## 技术实现亮点

### 1. 自实现加密算法（不使用SSL/TLS）

#### AES加密（AES-256-GCM）
- 文件存储使用AES-256-GCM模式加密
- 提供加密和完整性验证
- 每个文件使用独立的文件密钥

#### RSA加密（RSA-2048）
- 用于密钥交换和会话密钥加密传输
- 使用OAEP填充模式
- 支持大块数据分块加密

#### HMAC验证（HMAC-SHA256）
- 用于消息完整性验证
- 防止数据篡改
- 支持时间戳防重放攻击

### 2. 一次一密机制

- 每次用户登录生成新的会话密钥
- 会话密钥通过RSA加密传输给客户端
- 会话密钥存储在数据库中，但使用客户端公钥加密
- 服务器无法获取明文会话密钥

### 3. 双重认证机制

#### 密码认证
- 使用bcrypt进行密码哈希
- 密码强度验证
- 安全的密码存储

#### 邮箱验证码认证
- 生成6位数字验证码
- 验证码有效期10分钟
- 验证码使用后立即失效
- 支持登录和密钥找回两种用途

### 4. 密钥管理

#### 主密钥
- 用户注册时生成32字节主密钥
- 使用用户密码派生密钥加密存储
- 主密钥用于加密文件密钥

#### 文件密钥
- 每个文件使用独立的32字节密钥
- 文件密钥使用主密钥加密存储
- 只有拥有主密钥的用户可以解密

#### 密钥找回
- 注册时生成密钥恢复包
- 恢复包使用邮箱验证码加密
- 通过邮箱验证码可以找回主密钥
- 找回的主密钥可以解密所有历史文件

### 5. 用户组管理

- 用户可以创建用户组
- 用户可以加入其他用户组
- 用户组内文件共享
- 用户组之间完全隔离
- 支持组内密钥共享（通过RSA加密）

## 系统架构

### 后端架构

```
backend/
├── app.py              # Flask应用主文件
├── models.py           # 数据库模型
├── crypto/             # 加密模块
│   ├── aes.py         # AES加密实现
│   ├── rsa.py         # RSA加密实现
│   ├── hmac.py        # HMAC验证
│   └── key_manager.py # 密钥管理
├── auth/               # 认证模块
│   ├── password.py    # 密码认证
│   └── email.py       # 邮箱认证
├── api/                # API路由
│   ├── auth.py        # 认证接口
│   ├── files.py       # 文件接口
│   └── groups.py      # 用户组接口
└── utils/              # 工具函数
    └── validators.py  # 验证工具
```

### 前端架构

```
frontend/
├── src/
│   ├── components/     # React组件
│   ├── pages/          # 页面组件
│   │   ├── Login.tsx   # 登录页面
│   │   └── Dashboard.tsx # 主界面
│   ├── services/       # API服务
│   │   ├── authService.ts
│   │   ├── fileService.ts
│   │   └── groupService.ts
│   ├── utils/          # 工具函数
│   │   └── crypto.ts   # 加密工具
│   └── contexts/       # React Context
│       └── AuthContext.tsx
```

## 数据库设计

### 用户表（users）
- id: 用户ID
- username: 用户名（唯一）
- email: 邮箱（唯一）
- password_hash: 密码哈希
- encrypted_master_key: 加密的主密钥
- recovery_package: 密钥恢复包
- created_at: 创建时间
- last_login: 最后登录时间

### 文件表（files）
- id: 文件ID
- filename: 加密文件名
- original_filename: 原始文件名
- file_path: 文件存储路径
- file_size: 文件大小
- encrypted_file_key: 加密的文件密钥
- owner_id: 所有者ID
- group_id: 所属用户组ID（可选）
- mime_type: MIME类型
- created_at: 创建时间
- updated_at: 更新时间

### 用户组表（user_groups）
- id: 用户组ID
- name: 组名
- description: 描述
- created_by: 创建者ID
- created_at: 创建时间

### 组成员表（group_members）
- id: 成员关系ID
- user_id: 用户ID
- group_id: 用户组ID
- role: 角色（owner/admin/member）
- joined_at: 加入时间

### 会话表（sessions）
- id: 会话ID
- user_id: 用户ID
- session_token: 会话令牌
- encrypted_session_key: 加密的会话密钥
- created_at: 创建时间
- expires_at: 过期时间
- last_activity: 最后活动时间

### 邮箱验证码表（email_codes）
- id: 验证码ID
- email: 邮箱地址
- code: 验证码
- purpose: 用途（login/recover）
- created_at: 创建时间
- expires_at: 过期时间
- used: 是否已使用

## 安全机制详解

### 1. 防中间人攻击

- **RSA密钥交换**：会话密钥通过RSA加密传输
- **HMAC验证**：所有消息使用HMAC验证完整性
- **时间戳验证**：防止重放攻击
- **请求序列号**：可选的请求序列号验证

### 2. 防篡改

- **HMAC签名**：所有敏感数据使用HMAC签名
- **AES-GCM模式**：提供加密和完整性验证
- **文件哈希**：可选的文件哈希验证

### 3. 数据加密

- **传输加密**：使用RSA加密敏感数据
- **存储加密**：文件使用AES-256-GCM加密
- **密钥加密**：密钥使用主密钥加密存储

### 4. 访问控制

- **用户认证**：双重认证机制
- **会话管理**：会话token验证
- **权限控制**：用户组隔离
- **文件权限**：只有所有者可以删除文件

## 使用流程

### 用户注册流程

1. 用户填写用户名、邮箱、密码
2. 系统生成主密钥和RSA密钥对
3. 使用密码加密主密钥
4. 生成密钥恢复包
5. 返回公钥和恢复码给用户

### 用户登录流程

1. 用户选择登录方式（密码/邮箱验证码）
2. 系统验证用户身份
3. 生成新的会话密钥（一次一密）
4. 使用客户端公钥加密会话密钥
5. 返回会话token给客户端

### 文件上传流程

1. 客户端选择文件
2. 生成文件密钥
3. 使用文件密钥加密文件
4. 使用主密钥加密文件密钥
5. 上传加密文件和加密的文件密钥
6. 服务器存储加密文件

### 文件下载流程

1. 客户端请求下载文件
2. 服务器返回加密文件
3. 客户端使用主密钥解密文件密钥
4. 使用文件密钥解密文件
5. 保存解密后的文件

### 密钥找回流程

1. 用户输入邮箱地址
2. 系统发送验证码到邮箱
3. 用户输入验证码
4. 系统验证验证码
5. 返回密钥恢复包
6. 用户使用验证码解密恢复包
7. 获得主密钥，可以解密所有文件

## 测试说明

### 功能测试

1. **用户注册测试**
   - 注册新用户
   - 验证用户名唯一性
   - 验证邮箱唯一性
   - 验证密码强度

2. **用户登录测试**
   - 密码登录
   - 邮箱验证码登录
   - 错误密码/验证码处理

3. **文件管理测试**
   - 文件上传
   - 文件下载
   - 文件删除
   - 文件列表查看

4. **用户组测试**
   - 创建用户组
   - 加入用户组
   - 组内文件共享
   - 组间隔离

5. **密钥找回测试**
   - 发送验证码
   - 验证验证码
   - 恢复密钥
   - 解密历史文件

### 安全测试

1. **加密测试**
   - 验证文件加密存储
   - 验证服务器无法解密
   - 验证密钥加密存储

2. **传输安全测试**
   - 验证RSA密钥交换
   - 验证HMAC完整性
   - 验证会话密钥一次一密

3. **权限测试**
   - 验证用户组隔离
   - 验证文件访问权限
   - 验证会话过期处理

## 部署说明

### 开发环境

1. 后端：`python backend/app.py`
2. 前端：`cd frontend && npm start`

### 生产环境

1. 后端：使用Gunicorn或uWSGI部署
2. 前端：`npm run build`构建后部署到Nginx
3. 数据库：可迁移到PostgreSQL或MySQL
4. 文件存储：可迁移到对象存储服务

## 注意事项

1. **恢复码安全**：恢复码非常重要，请妥善保管
2. **密钥管理**：主密钥仅存储在客户端，服务器无法获取
3. **会话管理**：会话token存储在localStorage，登出时清除
4. **文件加密**：所有文件都加密存储，服务器无法查看内容
5. **用户组隔离**：用户组之间完全隔离，无法访问其他组的文件

## 项目特色

1. **完全自实现加密**：不使用SSL/TLS，所有加密算法自实现
2. **一次一密机制**：每次登录使用新的会话密钥
3. **双重认证**：支持密码和邮箱验证码两种登录方式
4. **密钥找回**：支持通过邮箱验证码找回密钥
5. **用户组管理**：支持用户组和组内文件共享
6. **美观界面**：使用Ant Design构建现代化UI
7. **完整功能**：实现题目要求的所有功能

## 技术栈总结

- **后端**：Python 3.8+, Flask, SQLAlchemy, cryptography
- **前端**：React 18, TypeScript, Ant Design 5
- **加密**：AES-256-GCM, RSA-2048, HMAC-SHA256, bcrypt
- **数据库**：SQLite（可扩展）
- **开发工具**：npm, pip
